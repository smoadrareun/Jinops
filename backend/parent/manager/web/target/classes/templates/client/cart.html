<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="renderer" content="webkit">
    <title></title>
    <link rel="stylesheet" href="../../static/css/pintuer.css">
    <link rel="stylesheet" href="../../static/css/client/admin.css">
    <script src="../../static/js/jquery.js"></script>
    <script src="../../static/js/pintuer.js"></script>
    <script type="text/javascript" src="../../static/js/client/index.js"></script>
</head>
<body>
<form method="post" action="" id="listform">
    <div class="panel admin-panel">
        <div class="panel-head"><strong class="icon-reorder"> 购物车</strong>
            <a href="" style="float:right; display:none;">添加字段</a>
        </div>
        <div class="padding border-bottom">
            <div id="tips"></div>
            <ul class="search padding-left">
                <li>
                    <strong>查询条件：</strong>
                </li>
                <li>
                    名称：<input type="text" placeholder="请输入搜索关键字" name="sname" class="input margin-little-top"
                              style="width:150px;display:inline-block"/>
                </li>
                <li>
                    价格区间：<input type="text" name="min" class="input margin-little-top" placeholder="最低价"
                                style="width:60px;display:inline-block" data-validate="regexp#^([0-9]*)+(\.[0-9])?([0-9])?$:"/>&nbsp;元-
                    <input type="text" name="max" class="input margin-little-top" placeholder="最高价"
                           style="width:60px;display:inline-block" data-validate="regexp#^([0-9]*)+(\.[0-9])?([0-9])?$:"/>&nbsp;元
                </li>
                <li>
                    排序方式：
                    <select name="sort" class="input" style="width:125px;display:inline-block">
                        <option value="0">默认排序</option>
                        <option value="1">价格升序</option>
                        <option value="2">价格降序</option>
                    </select>
                </li>
                <li>
                    每页显示：
                    <select name="count" class="input" style="width:125px;display:inline-block">
                        <option value="5">每页5条</option>
                        <option value="10">每页10条</option>
                        <option value="15">每页15条</option>
                        <option value="20">每页20条</option>
                        <option value="">显示全部</option>
                    </select>
                </li>
                <li>
                    <button type="button" class="button border-main icon-search" id="query">
                        查询
                    </button>
                    <button type="button" class="button border-dot icon-trash-o" id="clean">
                        清空
                    </button>
                </li>
            </ul>
        </div>
        <table class="table table-hover text-center">
            <tr>
                <th></th>
                <th>餐品图片</th>
                <th>餐品名称</th>
                <th>餐品价格</th>
                <th>餐品数量</th>
                <th>餐品总价</th>
                <th>操作</th>
            </tr>
            <tbody id="vo">
            </tbody>
        </table>
        <div class="padding border-bottom">
            <ul class="search padding-left padding-bottom border-bottom">
                <div class="button-group">
                    <button type="button" class="button border-main icon-check-circle" id="checkall">
                        全选
                    </button>
                    <button type="button" class="button border-main icon-circle-o" id="checknone">
                        全不选
                    </button>
                    <button type="button" class="button border-main icon-check-circle-o" id="inverse">
                        反选
                    </button>
                </div>
                <div class="button-group margin-left">
                    <button type="button" class="button border-dot icon-trash-o" id="deletes">
                        批量删除
                    </button>
                </div>
                <div class="button-group margin-right float-right">
                    <li>
                        总价：<strong id="total">0.00</strong>元
                    </li>
                    <button type="button" class="button border-main icon-mail-reply-all float-right" id="submits">
                        结算
                    </button>
                </div>
            </ul>
            <ul class="search padding-left padding-top">
                <input name="page" value="1" hidden="hidden"/>
                <div class="pagelist" id="pageList">

                </div>
            </ul>
        </div>
    </div>
</form>
<script type="text/javascript">
    $(function () {
        var success = "<div class=\"form-group animated bounce\">\n" +
            "                    <div class=\"alert alert-green\">\n" +
            "                        <span class=\"close rotate-hover\"></span><strong>恭喜：</strong>操作成功。\n" +
            "                    </div>\n" +
            "                </div>";

        var failure = "<div class=\"form-group animated bounce\">\n" +
            "                                            <div class=\"alert alert-yellow\">\n" +
            "                                                <span class=\"close rotate-hover\"></span><strong>操作失败</strong>\n" +
            "                                                <p>\n" +
            "                                                    请重新操作。\n" +
            "                                                </p>\n" +
            "                                            </div>";

        var error = "<div class=\"form-group animated bounce\">\n" +
            "                                            <div class=\"alert alert-red\">\n" +
            "                                                <span class=\"close rotate-hover\"></span><strong>访问异常</strong>\n" +
            "                                                <p>\n" +
            "                                                    请稍后重试。\n" +
            "                                                </p>\n" +
            "                                            </div>";

        function getWarning(str) {
            return "<div class=\"form-group animated bounce\">\n" +
                "                                            <div class=\"alert alert-yellow\">\n" +
                "                                                <span class=\"close rotate-hover\"></span><strong>注意：</strong>" + str + "\n" +
                "                                            </div>\n" +
                "                                        </div>";
        }

        function getTips(str) {
            return "<div class=\"form-group animated bounce\">\n" +
                "                                            <div class=\"alert alert-blue\">\n" +
                "                                                <span class=\"close rotate-hover\"></span><strong>提示：</strong>" + str + "\n" +
                "                                            </div>\n" +
                "                                        </div>";
        }

        queryList();

        //搜索
        function queryList(input) {
            var adata = {
                cliId: JSON.parse(sessionStorage.getItem("client")).id,
                name: $("input[name='sname']").val(),
                minPrice: $("input[name='min']").val(),
                maxPrice: $("input[name='max']").val(),
                sort: $("select[name='sort']").val(),
                pageSize: $("select[name='count']").val(),
                pageNum: $("input[name='page']").val(),
            };
            var data = JSON.stringify(adata);
            $.ajax({
                type: "POST",
                dataType: "json",
                contentType: "application/json",
                data: data,
                async: false,
                url: window.location.origin + "/Jinops/cart/select",
                success: function (data) {
                    if (data.code === 0) {
                        $("#vo").empty();
                        var x="<button type=\"button\" class=\"button button-little margin-right\" name=\"minus\">\n" +
                            "                        <strong>-</strong>\n" +
                            "                    </button>\n" +
                            "                    <input type=\"text\" class=\"input\" style=\"width:50px;display:inline-block\" value=\"1\">\n" +
                            "                    <button type=\"button\" class=\"button button-little margin-left\" name=\"plus\">\n" +
                            "                        <strong>+</strong>\n" +
                            "                    </button>";
                        for (var i = data.data.list.length - 1; i >= 0; i--) {
                            var str = "<tr><td><input type=\"checkbox\" name=\"id[]\" value=\"" + data.data.list[i].id + "\"/>\n" +
                                "                   <input type=\"checkbox\" name=\"gooId[]\" value=\"" + data.data.list[i].gooId + "\" hidden='hidden'/>\n" +
                                "                    <input type=\"checkbox\" name=\"total\" hidden='hidden'>\n" +
                                "                    <input type=\"checkbox\" name=\"sold\" hidden='hidden'>\n" +
                                "                    </td>\n" +
                                "                    <td><img src=\"" + data.data.list[i].pic + "\" alt=\"\" width=\"50\" height=\"50\"/></td>\n" +
                                "                    <td>" + data.data.list[i].name + "</td>\n" +
                                "                    <td>" + data.data.list[i].price.toFixed(2) + "</td>\n" +
                                "                    <td><button type=\"button\" class=\"button button-little margin-right\" name=\"minus\">\n" +
                                "                        <strong>-</strong>\n" +
                                "                    </button>\n" +
                                "                    <input type=\"text\" class=\"input\" style=\"width:50px;display:inline-block\" " +
                                "                           value=\""+data.data.list[i].num+"\" name=\"num\">\n" +
                                "                    <button type=\"button\" class=\"button button-little margin-left\" name=\"plus\">\n" +
                                "                        <strong>+</strong>\n" +
                                "                    </button></td>\n" +
                                "                    <td>" + (data.data.list[i].price*data.data.list[i].num).toFixed(2) + "</td>\n" +
                                "                    <td>\n" +
                                "                        <div class=\"button-group\">\n" +
                                "                           <button type=\"button\" class=\"button border-dot icon-trash-o\" \n" +
                                "                               name=\"delete\" value=\"" + data.data.list[i].id + "\">删除</input>\n" +
                                "                           </div>\n" +
                                "                    </td>\n" +
                                "                </tr>";
                            $("#vo").prepend(str);
                        }
                        $("#pageList").empty();
                        var str="";
                        if(data.data.pageNum>1) {
                            str +=  "<div class=\"button-group\">\n" +
                                "                <button type=\"button\" class=\"button border-sub\" name=\"firstPage\">\n" +
                                "                    首页\n" +
                                "                </button>\n" +
                                "                <button type=\"button\" class=\"button border-sub\" name=\"prevPage\">\n" +
                                "                    上一页\n" +
                                "                </button>\n" +
                                "           </div>\n";
                        }else{
                            str +=  "<div class=\"button-group\">\n" +
                                "                <button type=\"button\" class=\"button border-sub\"" +
                                "                       name=\"firstPage\" disabled=\"disabled\">\n" +
                                "                    首页\n" +
                                "                </button>\n" +
                                "                <button type=\"button\" class=\"button border-sub\"" +
                                "                       name=\"prevPage\" disabled=\"disabled\">\n" +
                                "                    上一页\n" +
                                "                </button>\n" +
                                "           </div>\n";
                        }
                        str+= "         <div class=\"button-group\">\n" +
                            "                <button type=\"button\" class=\"button bg-sub\" name=\"thisPage\">\n" +
                            "                    <input name=\"page\" hidden=\"hidden\" value='"+data.data.pageNum+"'/>\n" +
                            "                    <input name=\"totalPage\" hidden=\"hidden\" value='"+data.data.pages+"'/>\n" +
                            "                    第"+data.data.pageNum+"页,共"+data.data.pages+"页\n" +
                            "                </button>\n" +
                            "           </div>\n";
                        if(data.data.pageNum<data.data.pages){
                            str+= "         <div class=\"button-group\">\n" +
                                "                <button type=\"button\" class=\"button border-sub\" name=\"nextPage\">\n" +
                                "                    下一页\n" +
                                "                </button>\n" +
                                "                <button type=\"button\" class=\"button border-sub\" name=\"lastPage\">\n" +
                                "                    尾页\n" +
                                "                </button>\n" +
                                "           </div>\n";
                        }else{
                            str+= "         <div class=\"button-group\">\n" +
                                "                <button type=\"button\" class=\"button border-sub\"" +
                                "                        name=\"nextPage\" disabled=\"disabled\">\n" +
                                "                    下一页\n" +
                                "                </button>\n" +
                                "                <button type=\"button\" class=\"button border-sub\"" +
                                "                        name=\"lastPage\" disabled=\"disabled\">\n" +
                                "                    尾页\n" +
                                "                </button>\n" +
                                "           </div>\n";
                        }
                        $("#pageList").prepend(str);
                        $("input[name='page']").val(data.data.pageNum);

                        //跳转到首页
                        $("button[name='firstPage']").on("click",function (){
                            $("input[name='page']").val(1);
                            queryList();
                        })

                        //跳转到上一页
                        $("button[name='prevPage']").on("click",function (){
                            $("input[name='page']").val(parseInt($("input[name='page']").val())-1);
                            queryList();
                        })

                        //上一页
                        $("button[name='prev']").on("click",function (){
                            $("input[name='page']").val(parseInt($("input[name='page']").val())-1);
                            queryList();
                        })

                        //下一页
                        $("button[name='next']").on("click",function (){
                            $("input[name='page']").val(parseInt($("input[name='page']").val())+1);
                            queryList();
                        })

                        //跳转到下一页
                        $("button[name='nextPage']").on("click",function (){
                            $("input[name='page']").val(parseInt($("input[name='page']").val())+1);
                            queryList();
                        })

                        //跳转到尾页
                        $("button[name='lastPage']").on("click",function (){
                            $("input[name='page']").val(parseInt($("input[name='totalPage']").val()));
                            queryList();
                        })

                        //数量减
                        $("button[name='minus']").on("click",function (){
                            if($(this).next().val()==1){
                                if (confirm("确定要删除此项吗？")) {
                                    del($(this).parent().prev().prev().prev().prev().children().eq(0).val());
                                }
                            }else{
                                $(this).next().val(parseInt($(this).next().val())-1);
                                $(this).parent().next().text((parseFloat($(this).parent().prev().text())*parseInt($(this).next().val())).toFixed(2));
                                check();
                                totalPrice();
                            }
                        })

                        //数量修改
                        $("input[name='num']").on("change",function (){
                            find($(this).parent().prev().prev().prev().prev().children().eq(1).val());
                            if($(this).val()===null||$(this).val()===undefined||!Number.isInteger(parseFloat($(this).val()))){
                                window.scrollTo('0', '0');
                                $("#tips").html(getWarning("输入的数量不能为空或非正整数")).on("click", ".close", function () {
                                    $(this).parent().parent().remove();
                                });
                                $(this).val(1);
                                $(this).parent().next().text(parseFloat($(this).parent().prev().text()).toFixed(2));
                            }else if(parseInt($(this).val())<=0){
                                window.scrollTo('0', '0');
                                $("#tips").html(getWarning("输入的数量不能小于等于0")).on("click", ".close", function () {
                                    $(this).parent().parent().remove();
                                });
                                $(this).val(1);
                                $(this).parent().next().text(parseFloat($(this).parent().prev().text()).toFixed(2));
                            }else if(parseInt($(this).val())>parseInt($(this).parent().prev().prev().prev().prev().children().eq(2).val())){
                                window.scrollTo('0', '0');
                                $("#tips").html(getWarning("输入的数量不能大于库存")).on("click", ".close", function () {
                                    $(this).parent().parent().remove();
                                });
                                $(this).val(parseInt($(this).parent().prev().prev().prev().prev().children().eq(2).val()));
                                $(this).parent().next().text((parseInt($(this).val())*parseFloat($(this).parent().prev().text())).toFixed(2));
                            }else{
                                $(this).parent().next().text((parseInt($(this).val())*parseFloat($(this).parent().prev().text())).toFixed(2));
                            }
                            check();
                            totalPrice();
                        })

                        //数量加
                        $("button[name='plus']").on("click",function (){
                            find($(this).parent().prev().prev().prev().prev().children().eq(1).val());
                            if(parseInt($(this).prev().val())>=parseInt($(this).parent().prev().prev().prev().prev().children().eq(2).val())){
                                window.scrollTo('0', '0');
                                $("#tips").html(getWarning("增加的数量不能大于库存")).on("click", ".close", function () {
                                    $(this).parent().parent().remove();
                                });
                                $(this).prev().val(parseInt($(this).parent().prev().prev().prev().prev().children().eq(2).val()));
                                $(this).parent().next().text((parseFloat($(this).parent().prev().text())*parseInt($(this).prev().val())).toFixed(2));
                            }else{
                                $(this).prev().val(parseInt($(this).prev().val())+1);
                                $(this).parent().next().text((parseFloat($(this).parent().prev().text())*parseInt($(this).prev().val())).toFixed(2));
                            }
                            check();
                            totalPrice();
                        })

                        //删除
                        $("button[name='delete']").on("click",function (){
                            if (confirm("确定要删除此项吗？")) {
                                del(this.value);
                                totalPrice();
                            }
                        })

                        if(input!==null&&input!==undefined){
                            window.scrollTo('0', '0');
                            $("#tips").html(success).on("click", ".close", function () {
                                $(this).parent().parent().remove();
                            });
                        }

                        check();
                    }
                    if (data.code === -404) {
                        $("#vo").empty();
                        $("#pageList").empty();
                        window.scrollTo('0', '0');
                        $("#tips").html(getWarning("暂未找到餐品数据")).on("click", ".close", function () {
                            $(this).parent().parent().remove();
                        });
                    }
                    if (data.code === -1) {
                        window.scrollTo('0', '0');
                        $("#tips").html(failure).on("click", ".close", function () {
                            $(this).parent().parent().remove();
                        });
                    }
                },
                error: function (e) {
                    console.log(e);
                    window.scrollTo('0', '0');
                    $("#tips").html(error).on("click", ".close", function () {
                        $(this).parent().parent().remove();
                    });
                }
            })
        }

        //删除
        function del(id) {
            $.ajax({
                type: "POST",
                dataType: "json",
                contentType: "application/json",
                async: false,
                url: window.location.origin + "/Jinops/cart/delete/" + id,
                success: function (data) {
                    if (data.code === 0) {
                        $("input[name='id[]']").each(function () {
                            if (this.value === id) {
                                $(this).parent().parent().remove();
                            }
                        });
                        window.scrollTo('0', '0');
                        $("#tips").html(success).on("click", ".close", function () {
                            $(this).parent().parent().remove();
                        });
                    }
                    if (data.code === -404) {
                        window.scrollTo('0', '0');
                        $("#tips").html(getWarning("删除的餐品不存在")).on("click", ".close", function () {
                            $(this).parent().parent().remove();
                        });
                    }
                    if (data.code === -1) {
                        window.scrollTo('0', '0');
                        $("#tips").html(failure).on("click", ".close", function () {
                            $(this).parent().parent().remove();
                        });
                    }
                },
                error: function (e) {
                    console.log(e);
                    window.scrollTo('0', '0');
                    $("#tips").html(error).on("click", ".close", function () {
                        $(this).parent().parent().remove();
                    });
                }
            })
        }

        //查找
        function find(id) {
            var num;
            $("input[name='gooId[]']").each(function () {
                if (this.value===id) {
                    num=$(this).parent().children().eq(2);
                }
            });
            $.ajax({
                type: "POST",
                dataType: "json",
                contentType: "application/json",
                async: false,
                url: window.location.origin + "/Jinops/goods/getById/" + id,
                success: function (data) {
                    if (data.code === 0) {
                        $(num).val(parseInt(data.data.num));
                        $(num).next().val(parseInt(data.data.sold));
                    }
                    if (data.code === -404) {
                        window.scrollTo('0', '0');
                        $("#tips").html(getWarning("要查找的餐品不存在")).on("click", ".close", function () {
                            $(this).parent().parent().remove();
                        });
                    }
                    if (data.code === -1) {
                        window.scrollTo('0', '0');
                        $("#tips").html(failure).on("click", ".close", function () {
                            $(this).parent().parent().remove();
                        });
                    }
                },
                error: function (e) {
                    console.log(e);
                    window.scrollTo('0', '0');
                    $("#tips").html(error).on("click", ".close", function () {
                        $(this).parent().parent().remove();
                    });
                }
            })
        }

        //修改
        function edit(id) {
            var num=1;
            $("input[name='id[]']").each(function () {
                if (this.value===id) {
                    num=$(this).parent().next().next().next().next().children().eq(1).val();
                }
            });
            var adata = {
                id: id,
                num: num,
            };
            var data = JSON.stringify(adata);
            $.ajax({
                type: "POST",
                dataType: "json",
                contentType: "application/json",
                data:data,
                async: false,
                url: window.location.origin + "/Jinops/cart/update/",
                success: function (data) {
                    if (data.code === -404) {
                        window.scrollTo('0', '0');
                        $("#tips").html(getWarning("要修改的餐品不存在")).on("click", ".close", function () {
                            $(this).parent().parent().remove();
                        });
                    }
                    if (data.code === -1) {
                        window.scrollTo('0', '0');
                        $("#tips").html(failure).on("click", ".close", function () {
                            $(this).parent().parent().remove();
                        });
                    }
                },
                error: function (e) {
                    console.log(e);
                    window.scrollTo('0', '0');
                    $("#tips").html(error).on("click", ".close", function () {
                        $(this).parent().parent().remove();
                    });
                }
            })
        }

        //检查
        function check() {
            $("input[name='gooId[]']").each(function () {
                var gooId=$(this);
                $.ajax({
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json",
                    async: false,
                    url: window.location.origin + "/Jinops/goods/getById/" + this.value,
                    success: function (data) {
                        if (data.code === 0) {
                            if(data.data.status===-1||parseInt(data.data.num)<=0){
                                $(gooId).prev().prop("disabled",true).prop("checked",false);
                                $(gooId).parent().next().next().next().next().children().eq(0).prop("disabled", true);
                                $(gooId).parent().next().next().next().next().children().eq(1).val(1).prop("disabled", true);
                                $(gooId).parent().next().next().next().next().children().eq(2).prop("disabled", true);
                                edit($(gooId).prev().val());
                                // del($(gooId).prev().val());
                                window.scrollTo('0', '0');
                                $("#tips").html(getTips("请注意部分餐品发生变更")).on("click", ".close", function () {
                                    $(this).parent().parent().remove();
                                });
                            }else if(parseInt($(gooId).parent().next().next().next().next().children().eq(1).val())>parseInt(data.data.num)){
                                $(gooId).prev().prop("disabled", false);
                                $(gooId).parent().next().next().next().next().children().eq(0).prop("disabled", false);
                                $(gooId).parent().next().next().next().next().children().eq(1).val(data.data.num).prop("disabled", false);
                                $(gooId).parent().next().next().next().next().children().eq(2).prop("disabled", false);
                                edit($(gooId).prev().val());
                            }else{
                                $(gooId).prev().prop("disabled", false);
                                $(gooId).parent().next().next().next().next().children().eq(0).prop("disabled", false);
                                $(gooId).parent().next().next().next().next().children().eq(1).prop("disabled", false);
                                $(gooId).parent().next().next().next().next().children().eq(2).prop("disabled", false);
                                edit($(gooId).prev().val());
                            }
                        }
                        if (data.code === -404) {
                            del($(gooId).prev().val());
                            window.scrollTo('0', '0');
                            $("#tips").html(getTips("请注意部分餐品发生变更")).on("click", ".close", function () {
                                $(this).parent().parent().remove();
                            });
                        }
                        if (data.code === -1) {
                            window.scrollTo('0', '0');
                            $("#tips").html(failure).on("click", ".close", function () {
                                $(this).parent().parent().remove();
                            });
                        }
                    },
                    error: function (e) {
                        console.log(e);
                        window.scrollTo('0', '0');
                        $("#tips").html(error).on("click", ".close", function () {
                            $(this).parent().parent().remove();
                        });
                    }
                })
            })
        }

        //查询
        $("#query").click(function () {
            $("input[name='page']").val(1);
            queryList(1);
            totalPrice();
        })

        //清空
        $("#clean").click(function () {
            if (confirm("您确定要清空所有查询的条件吗？")) {
                $("input[name='sname']").val("");
                $("input[name='min']").val("");
                $("input[name='max']").val("");
                $("select[name='sort']").val("0");
                $("select[name='count']").val("4");
                queryList(1);
            }
            totalPrice();
        })

        //全选
        $("#checkall").click(function () {
            $("input[name='id[]']").each(function () {
                this.checked = true;
            });
            totalPrice();
        })

        //全不选
        $("#checknone").click(function () {
            $("input[name='id[]']").each(function () {
                this.checked = false;
            });
            totalPrice();
        })

        //反选
        $("#inverse").click(function () {
            $("input[name='id[]']").each(function () {
                if (this.checked) {
                    this.checked = false;
                } else {
                    this.checked = true;
                }
            });
            totalPrice();
        })

        //批量删除
        $("#deletes").click(function () {
            var Checkbox = 0;
            $("input[name='id[]']").each(function () {
                if (this.checked === true) {
                    Checkbox++;
                }
            });
            if (Checkbox>0) {
                if (confirm("您确定要删除选中的"+Checkbox+"件餐品吗？")) {
                    $("input[name='id[]']").each(function () {
                        if (this.checked === true) {
                            del(this.value);
                        }
                    });
                    totalPrice();
                }
            } else {
                window.scrollTo('0', '0');
                $("#tips").html(getTips("请先选择要删除的餐品")).on("click", ".close", function () {
                    $(this).parent().parent().remove();
                });
            }
        })

        //结算
        $("#submits").click(function () {
            check();
            var Checkbox = 0;
            $("input[name='id[]']").each(function () {
                if (this.checked === true) {
                    Checkbox++;
                }
            });
            if (Checkbox>0) {
                if (confirm("您确定要结算选中的"+Checkbox+"件餐品吗？")) {
                    $("input[name='id[]']").each(function () {
                        if (this.checked === true) {
                            var id = $(this);
                            find($(this).next().val());
                            var xdata = {
                                id: $(this).next().val(),
                                num: parseInt($(this).next().next().val())-parseInt($(this).parent().next().next().next().next().children().eq(1).val()),
                                sold: parseInt($(this).next().next().next().val())+parseInt($(this).parent().next().next().next().next().children().eq(1).val()),
                            };
                            var data = JSON.stringify(xdata);
                            $.ajax({
                                type: "POST",
                                dataType: "json",
                                contentType: "application/json",
                                data:data,
                                async: false,
                                url: window.location.origin + "/Jinops/goods/update/",
                                success: function (data) {
                                    if (data.code === 0){
                                        var ydata = {
                                            cliId: JSON.parse(sessionStorage.getItem("client")).id,
                                            price: $(id).parent().next().next().next().next().next().text(),
                                            name: JSON.parse(sessionStorage.getItem("client")).addrInfo[0].name,
                                            phone: JSON.parse(sessionStorage.getItem("client")).addrInfo[0].phone,
                                            address: JSON.parse(sessionStorage.getItem("client")).addrInfo[0].address,
                                        };
                                        var data = JSON.stringify(ydata);
                                        $.ajax({
                                            type: "POST",
                                            dataType: "json",
                                            contentType: "application/json",
                                            data:data,
                                            async: false,
                                            url: window.location.origin + "/Jinops/order/insert/",
                                            success: function (data) {
                                                if (data.code === 0) {
                                                    var ydata = {
                                                        ordId: data.data.id,
                                                        name: $(id).parent().next().next().text(),
                                                        num: $(id).parent().next().next().next().next().children().eq(1).val(),
                                                        price: $(id).parent().next().next().next().next().next().text(),
                                                    };
                                                    var data = JSON.stringify(ydata);
                                                    $.ajax({
                                                        type: "POST",
                                                        dataType: "json",
                                                        contentType: "application/json",
                                                        data:data,
                                                        async: false,
                                                        url: window.location.origin + "/Jinops/order/insertComInfo/",
                                                        success: function (data) {
                                                            if (data.code === 0) {
                                                                del($(id).val());
                                                                totalPrice();
                                                                window.scrollTo('0', '0');
                                                                $("#tips").html(success).on("click", ".close", function () {
                                                                    $(this).parent().parent().remove();
                                                                });
                                                            }
                                                            if (data.code === -404) {
                                                                window.scrollTo('0', '0');
                                                                $("#tips").html(getWarning("要修改的餐品不存在")).on("click", ".close", function () {
                                                                    $(this).parent().parent().remove();
                                                                });
                                                            }
                                                            if (data.code === -1) {
                                                                window.scrollTo('0', '0');
                                                                $("#tips").html(failure).on("click", ".close", function () {
                                                                    $(this).parent().parent().remove();
                                                                });
                                                            }
                                                        },
                                                        error: function (e) {
                                                            console.log(e);
                                                            window.scrollTo('0', '0');
                                                            $("#tips").html(error).on("click", ".close", function () {
                                                                $(this).parent().parent().remove();
                                                            });
                                                        }
                                                    })
                                                }
                                                if (data.code === -404) {
                                                    window.scrollTo('0', '0');
                                                    $("#tips").html(getWarning("要修改的餐品不存在")).on("click", ".close", function () {
                                                        $(this).parent().parent().remove();
                                                    });
                                                }
                                                if (data.code === -1) {
                                                    window.scrollTo('0', '0');
                                                    $("#tips").html(failure).on("click", ".close", function () {
                                                        $(this).parent().parent().remove();
                                                    });
                                                }
                                            },
                                            error: function (e) {
                                                console.log(e);
                                                window.scrollTo('0', '0');
                                                $("#tips").html(error).on("click", ".close", function () {
                                                    $(this).parent().parent().remove();
                                                });
                                            }
                                        })
                                    }
                                    if (data.code === -404) {
                                        window.scrollTo('0', '0');
                                        $("#tips").html(getWarning("要修改的餐品不存在")).on("click", ".close", function () {
                                            $(this).parent().parent().remove();
                                        });
                                    }
                                    if (data.code === -1) {
                                        window.scrollTo('0', '0');
                                        $("#tips").html(failure).on("click", ".close", function () {
                                            $(this).parent().parent().remove();
                                        });
                                    }
                                },
                                error: function (e) {
                                    console.log(e);
                                    window.scrollTo('0', '0');
                                    $("#tips").html(error).on("click", ".close", function () {
                                        $(this).parent().parent().remove();
                                    });
                                }
                            })
                        }
                    });
                }
            } else {
                totalPrice();
                window.scrollTo('0', '0');
                $("#tips").html(getTips("请先选择要结算的餐品")).on("click", ".close", function () {
                    $(this).parent().parent().remove();
                });
            }
        })

        //选中状态改变
        $("input[name='id[]']").change(function () {
            totalPrice();
        });

        function totalPrice(){
            var total=0;
            $("input[name='id[]']").each(function () {
                if (this.checked === true) {
                    total+=parseFloat($(this).parent().next().next().next().next().next().text());
                }
            });
            $("#total").text(total.toFixed(2));
        }

    })

</script>
</body>
</html>